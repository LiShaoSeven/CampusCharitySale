<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校园义卖性价比模拟系统</title>
    <!-- 引入ECharts可视化 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "微软雅黑", "Microsoft YaHei", sans-serif;
        }
        body {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
            background-color: #f0f2f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        h1 {
            text-align: center;
            color: #1f2937;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 600;
        }
        h2 {
            color: #1f2937;
            font-size: 18px;
            margin: 20px 0 15px;
            border-left: 4px solid #2563eb;
            padding-left: 10px;
        }
        /* 场景参数样式 */
        .scene-params {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8fafc;
            border-radius: 8px;
        }
        .param-item {
            flex: 1;
            min-width: 150px;
        }
        .param-item label {
            display: block;
            margin-bottom: 8px;
            color: #4b5563;
            font-weight: 500;
        }
        .param-item input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        /* 按钮样式 */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .add-btn, .calculate-btn, .reset-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        .add-btn {
            background-color: #2563eb;
            color: white;
        }
        .add-btn:hover {
            background-color: #1d4ed8;
        }
        .calculate-btn {
            background-color: #10b981;
            color: white;
        }
        .calculate-btn:hover {
            background-color: #059669;
        }
        .reset-btn {
            background-color: #6b7280;
            color: white;
        }
        .reset-btn:hover {
            background-color: #4b5563;
        }
        /* 表格样式 */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 12px;
            text-align: center;
        }
        th {
            background-color: #2563eb;
            color: white;
            font-weight: 500;
        }
        tr:nth-child(even) {
            background-color: #f8fafc;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
        }
        .result-cell {
            color: #2563eb;
            font-weight: bold;
        }
        /* 结果展示样式 */
        .result-section {
            margin-top: 30px;
        }
        .sort-result, .simulation-result {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .sort-result h3, .simulation-result h3 {
            color: #2563eb;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .sort-list {
            line-height: 2;
            font-size: 14px;
        }
        .chart-container {
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }
        .profit-diff {
            color: #10b981;
            font-weight: bold;
            font-size: 16px;
            margin-top: 10px;
        }
        .capacity-tips {
            color: #dc2626;
            font-size: 14px;
            margin-top: 10px;
        }
        .simulate-tips {
            color: #2563eb;
            font-size: 14px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>校园义卖性价比模拟系统</h1>

        <!-- 场景参数设置区（核心：单客限购 + 摊位最大容量） -->
        <h2>一、义卖场景参数</h2>
        <div class="scene-params">
            <div class="param-item">
                <label for="totalTime">义卖总时长（分钟）</label>
                <input type="number" id="totalTime" value="240" min="1" step="1">
            </div>
            <div class="param-item">
                <label for="flowRate">客流量（人/分钟）</label>
                <input type="number" id="flowRate" value="0.5" min="0.1" step="0.1">
            </div>
            <div class="param-item">
                <label for="buyLimit">单客限购数（件/人）</label>
                <input type="number" id="buyLimit" value="3" min="1" step="1">
            </div>
            <div class="param-item">
                <label for="stallCapacity">摊位最大容量（件商品）</label>
                <input type="number" id="stallCapacity" value="6" min="1" step="1">
            </div>
        </div>

        <!-- 商品参数表格（带默认8件商品数据） -->
        <h2>二、商品参数</h2>
        <div class="btn-group">
            <button class="add-btn" onclick="addRow()">+ 添加商品行</button>
            <button class="calculate-btn" onclick="calculateAll()">一键计算+模拟利润</button>
            <button class="reset-btn" onclick="resetData()">重置默认数据</button>
        </div>
        <table id="goodsTable">
            <thead>
                <tr>
                    <th>商品ID</th>
                    <th>购买概率(l)</th>
                    <th>单件利润(m/元)</th>
                    <th>浏览时间(t/分钟)</th>
                    <th>跳过概率(q)</th>
                    <th>离开概率(r)</th>
                    <th>l×m</th>
                    <th>性价比</th>
                    <th>摆放顺序</th>
                </tr>
            </thead>
            <tbody>
                <!-- 默认8件商品数据 -->
                <tr>
                    <td><input type="number" value="1" min="1" readonly></td>
                    <td><input type="number" value="0.6" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td><input type="number" value="10.0" step="0.01" min="0"></td>
                    <td><input type="number" value="2.5" step="0.01" min="0"></td>
                    <td><input type="number" value="0.3" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td><input type="number" value="0.1" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td class="result-cell"></td>
                    <td class="result-cell"></td>
                    <td class="result-cell"></td>
                </tr>
                <tr>
                    <td><input type="number" value="2" min="1" readonly></td>
                    <td><input type="number" value="0.5" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td><input type="number" value="5.0" step="0.01" min="0"></td>
                    <td><input type="number" value="1.5" step="0.01" min="0"></td>
                    <td><input type="number" value="0.35" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td><input type="number" value="0.15" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td class="result-cell"></td>
                    <td class="result-cell"></td>
                    <td class="result-cell"></td>
                </tr>
                <tr>
                    <td><input type="number" value="3" min="1" readonly></td>
                    <td><input type="number" value="0.4" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td><input type="number" value="15.0" step="0.01" min="0"></td>
                    <td><input type="number" value="3.0" step="0.01" min="0"></td>
                    <td><input type="number" value="0.4" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td><input type="number" value="0.2" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td class="result-cell"></td>
                    <td class="result-cell"></td>
                    <td class="result-cell"></td>
                </tr>
                <tr>
                    <td><input type="number" value="4" min="1" readonly></td>
                    <td><input type="number" value="0.55" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td><input type="number" value="8.0" step="0.01" min="0"></td>
                    <td><input type="number" value="2.0" step="0.01" min="0"></td>
                    <td><input type="number" value="0.3" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td><input type="number" value="0.15" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td class="result-cell"></td>
                    <td class="result-cell"></td>
                    <td class="result-cell"></td>
                </tr>
                <tr>
                    <td><input type="number" value="5" min="1" readonly></td>
                    <td><input type="number" value="0.7" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td><input type="number" value="3.0" step="0.01" min="0"></td>
                    <td><input type="number" value="1.0" step="0.01" min="0"></td>
                    <td><input type="number" value="0.2" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td><input type="number" value="0.1" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td class="result-cell"></td>
                    <td class="result-cell"></td>
                    <td class="result-cell"></td>
                </tr>
                <tr>
                    <td><input type="number" value="6" min="1" readonly></td>
                    <td><input type="number" value="0.3" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td><input type="number" value="25.0" step="0.01" min="0"></td>
                    <td><input type="number" value="4.0" step="0.01" min="0"></td>
                    <td><input type="number" value="0.5" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td><input type="number" value="0.2" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td class="result-cell"></td>
                    <td class="result-cell"></td>
                    <td class="result-cell"></td>
                </tr>
                <tr>
                    <td><input type="number" value="7" min="1" readonly></td>
                    <td><input type="number" value="0.5" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td><input type="number" value="12.0" step="0.01" min="0"></td>
                    <td><input type="number" value="2.2" step="0.01" min="0"></td>
                    <td><input type="number" value="0.35" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td><input type="number" value="0.15" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td class="result-cell"></td>
                    <td class="result-cell"></td>
                    <td class="result-cell"></td>
                </tr>
                <tr>
                    <td><input type="number" value="8" min="1" readonly></td>
                    <td><input type="number" value="0.65" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td><input type="number" value="6.5" step="0.01" min="0"></td>
                    <td><input type="number" value="1.8" step="0.01" min="0"></td>
                    <td><input type="number" value="0.25" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td><input type="number" value="0.1" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                    <td class="result-cell"></td>
                    <td class="result-cell"></td>
                    <td class="result-cell"></td>
                </tr>
            </tbody>
        </table>

        <!-- 结果展示区 -->
        <div class="result-section">
            <div class="sort-result">
                <h3>最优摆放顺序（数字越小越靠前）：</h3>
                <div class="sort-list" id="sortResult">请先点击「一键计算+模拟利润」</div>
                <div class="capacity-tips" id="capacityTips"></div>
            </div>

            <div class="simulation-result">
                <h3>利润模拟对比（优化排序 vs 默认排序）：</h3>
                <div id="simulationText">请先点击计算</div>
                <div class="simulate-tips">模拟规则：200次随机模拟取平均值，结果更精准</div>
                <div class="profit-diff" id="profitDiff"></div>
                <div class="chart-container" id="profitChart"></div>
            </div>
        </div>
    </div>

    <script>
        // 初始化ECharts实例
        let myChart = echarts.init(document.getElementById('profitChart'));

        // 添加商品行
        function addRow() {
            const table = document.getElementById('goodsTable').querySelector('tbody');
            const lastRow = table.lastElementChild;
            const lastId = parseInt(lastRow.querySelector('td:first-child input').value);
            const newRow = document.createElement('tr');
            
            newRow.innerHTML = `
                <td><input type="number" value="${lastId + 1}" min="1" readonly></td>
                <td><input type="number" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                <td><input type="number" step="0.01" min="0"></td>
                <td><input type="number" step="0.01" min="0"></td>
                <td><input type="number" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                <td><input type="number" step="0.01" min="0" max="1" onblur="checkSum(this)"></td>
                <td class="result-cell"></td>
                <td class="result-cell"></td>
                <td class="result-cell"></td>
            `;
            table.appendChild(newRow);
        }

        // 校验l+q+r=1
        function checkSum(input) {
            const row = input.closest('tr');
            const l = parseFloat(row.cells[1].querySelector('input').value) || 0;
            const q = parseFloat(row.cells[4].querySelector('input').value) || 0;
            const r = parseFloat(row.cells[5].querySelector('input').value) || 0;
            
            const sum = (l + q + r).toFixed(2);
            if (sum !== '1.00' && l && q && r) {
                alert(`商品ID${row.cells[0].querySelector('input').value}：l+q+r=${sum}，需等于1！`);
            }
        }

        // 重置默认数据
        function resetData() {
            location.reload(); // 刷新页面恢复初始默认数据
        }

        // 全局计算+利润模拟
        function calculateAll() {
            const table = document.getElementById('goodsTable').querySelector('tbody');
            const rows = table.querySelectorAll('tr');
            let totalLM = 0; // 总赚钱潜力
            const goodsList = []; // 存储商品数据
            
            // 第一步：校验并计算l×m和总赚钱潜力
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const id = parseInt(row.cells[0].querySelector('input').value);
                const l = parseFloat(row.cells[1].querySelector('input').value) || 0;
                const m = parseFloat(row.cells[2].querySelector('input').value) || 0;
                const t = parseFloat(row.cells[3].querySelector('input').value) || 0;
                const q = parseFloat(row.cells[4].querySelector('input').value) || 0;
                const r = parseFloat(row.cells[5].querySelector('input').value) || 0;

                // 校验必填项
                if (l === 0 || m === 0 || t === 0 || q === 0 || r === 0) {
                    alert(`商品ID${id}：参数不能为空，请填写完整！`);
                    return;
                }
                if ((l + q + r).toFixed(2) !== '1.00') {
                    alert(`商品ID${id}：l+q+r必须等于1，请修正！`);
                    return;
                }

                const lm = (l * m).toFixed(2);
                row.cells[6].textContent = lm;
                totalLM += parseFloat(lm);
                goodsList.push({
                    id, l, m, t, q, r, lm: parseFloat(lm), row
                });
            }

            // 第二步：计算性价比
            goodsList.forEach(goods => {
                const numerator = Math.pow(goods.lm, 2); // (l×m)²
                const denominator = goods.t * (goods.q + goods.r * (totalLM / goods.lm));
                const ratio = (numerator / denominator).toFixed(2);
                goods.ratio = parseFloat(ratio);
                goods.row.cells[7].textContent = ratio;
            });

            // 第三步：排序并生成摆放顺序
            // 优化排序（按性价比降序）
            const optimizedList = [...goodsList].sort((a, b) => b.ratio - a.ratio);
            optimizedList.forEach((goods, index) => {
                const rank = index + 1;
                goods.row.cells[8].textContent = rank;
                goods.rank = rank;
            });

            // 默认排序（按ID升序）
            const defaultList = [...goodsList].sort((a, b) => a.id - b.id);

            // 第四步：展示摆放顺序+摊位容量提示
            const stallCapacity = parseInt(document.getElementById('stallCapacity').value) || 6;
            const sortText = optimizedList.map(g => `商品${g.id}（性价比：${g.ratio}）→ 摆放位置${g.rank}`).join('<br>');
            document.getElementById('sortResult').innerHTML = sortText;
            document.getElementById('capacityTips').innerHTML = `摊位容量限制：仅展示前${stallCapacity}件商品（ID：${optimizedList.slice(0, stallCapacity).map(g => g.id).join(', ')}）`;

            // 第五步：利润模拟计算（200次平均）
            simulateProfit(optimizedList, defaultList, stallCapacity);
        }

        // 利润模拟函数（200次取平均 + 摊位容量限制）
        function simulateProfit(optimizedList, defaultList, stallCapacity) {
            // 获取场景参数
            const totalTime = parseFloat(document.getElementById('totalTime').value) || 120;
            const flowRate = parseFloat(document.getElementById('flowRate').value) || 5;
            const buyLimit = parseInt(document.getElementById('buyLimit').value) || 2;

            // 总客流量 = 总时长 × 客流量
            const totalCustomer = totalTime * flowRate;
            // 单客可浏览商品数 = 基于商品平均浏览时间计算（固定5分钟浏览时长）
            const avgGoodsTime = optimizedList.reduce((sum, g) => sum + g.t, 0) / optimizedList.length;
            const browseCountPerCustomer = Math.floor(5 / avgGoodsTime);

            // 裁剪商品列表到摊位容量
            const optimizedListLimit = optimizedList.slice(0, stallCapacity);
            const defaultListLimit = defaultList.slice(0, stallCapacity);

            // 计算单种排序的总利润
            function calcProfit(sortList) {
                let totalProfit = 0;
                // 遍历每个顾客
                for (let c = 0; c < totalCustomer; c++) {
                    let totalBuyCount = 0; // 单客已购买总件数（不超buyLimit）
                    
                    // 顾客浏览商品（最多浏览browseCountPerCustomer件，或买到限购数为止）
                    for (let i = 0; i < Math.min(browseCountPerCustomer, sortList.length); i++) {
                        if (totalBuyCount >= buyLimit) break;
                        const goods = sortList[i];
                        
                        // 随机判断是否购买（按购买概率l）
                        if (Math.random() <= goods.l) {
                            totalProfit += goods.m;
                            totalBuyCount++;
                        }
                        // 随机判断是否离开（按离开概率r）
                        if (Math.random() <= goods.r) break;
                    }
                }
                return Math.round(totalProfit);
            }

            // 模拟200次取平均值（核心修改点）
            const simulateTimes = 200;
            let optimizedProfit = 0;
            let defaultProfit = 0;
            for (let i = 0; i < simulateTimes; i++) {
                optimizedProfit += calcProfit(optimizedListLimit);
                defaultProfit += calcProfit(defaultListLimit);
            }
            optimizedProfit = Math.round(optimizedProfit / simulateTimes);
            defaultProfit = Math.round(defaultProfit / simulateTimes);
            const profitIncrease = optimizedProfit - defaultProfit;
            const increaseRate = ((profitIncrease / defaultProfit) * 100).toFixed(2);

            // 展示模拟结果（标注摊位容量+模拟次数）
            document.getElementById('simulationText').innerHTML = `
                模拟条件：义卖总时长${totalTime}分钟，客流量${flowRate}人/分钟<br>
                规则：单客限购${buyLimit}件，摊位最大容量${stallCapacity}件<br>
                默认排序（按ID）总利润：${defaultProfit}元<br>
                优化排序（按性价比）总利润：${optimizedProfit}元
            `;
            document.getElementById('profitDiff').innerHTML = `
                利润提升：${profitIncrease}元（提升幅度${increaseRate}%）
            `;

            // 绘制可视化图表
            myChart.setOption({
                title: { text: '义卖利润对比（200次模拟平均值）', left: 'center' },
                tooltip: { trigger: 'axis' },
                legend: { data: ['总利润（元）'], left: 'left' },
                xAxis: {
                    type: 'category',
                    data: ['默认排序（按ID）', '优化排序（按性价比）']
                },
                yAxis: { type: 'value', name: '利润（元）' },
                series: [{
                    name: '总利润',
                    type: 'bar',
                    data: [defaultProfit, optimizedProfit],
                    itemStyle: {
                        color: ['#94a3b8', '#2563eb']
                    },
                    label: {
                        show: true,
                        position: 'top',
                        formatter: '{c}元'
                    }
                }]
            });
        }

        // 页面加载完成后初始化图表
        window.onload = function() {
            myChart.setOption({
                title: { text: '义卖利润对比（200次模拟平均值）', left: 'center' },
                tooltip: { trigger: 'axis' },
                legend: { data: ['总利润（元）'], left: 'left' },
                xAxis: { type: 'category', data: ['默认排序（按ID）', '优化排序（按性价比）'] },
                yAxis: { type: 'value', name: '利润（元）' },
                series: [{ name: '总利润', type: 'bar', data: [0, 0] }]
            });
        };
    </script>
</body>
</html>